---
import FallbackImage from "../assets/blog-placeholder-1.jpg";

interface Props {
  src: any;
  alt: string;
  width?: number;
  height?: number;
  class?: string;
  priority?: boolean;
  aspectRatio?: string;
}

const { src, alt, width, height, class: className, priority = false, aspectRatio = "16/9" } = Astro.props;

// Use fallback if src is undefined or invalid
let imgSrc = typeof src === 'string' ? src : src?.src;
if (!imgSrc || imgSrc.includes('undefined')) {
  imgSrc = FallbackImage;
}

const imgWidth = width || (typeof src === 'object' ? src?.width : undefined);
const imgHeight = height || (typeof src === 'object' ? src?.height : undefined);
---

<div class={`lazy-image-wrapper ${className || ''}`} style={`aspect-ratio: ${aspectRatio};`}>
  <img
    src={imgSrc}
    alt={alt}
    width={imgWidth}
    height={imgHeight}
    loading={priority ? "eager" : "lazy"}
    decoding={priority ? "sync" : "async"}
    class="lazy-image"
  />
</div>

<style>
  .lazy-image-wrapper {
    position: relative;
    overflow: hidden;
    background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);
    width: 100%;
  }

  .lazy-image {
    display: block;
    width: 100%;
    height: 100%;
    object-fit: cover;
    opacity: 0;
    transition: opacity 0.5s ease-in-out;
  }

  .lazy-image.loaded {
    opacity: 1;
  }
</style>

<script>
  function initLazyImages() {
    const images = document.querySelectorAll('.lazy-image');
    
    images.forEach(img => {
      if (img instanceof HTMLImageElement) {
        if (img.complete) {
          img.classList.add('loaded');
        } else {
          img.addEventListener('load', () => {
            img.classList.add('loaded');
          });
        }
      }
    });
  }

  initLazyImages();
  document.addEventListener('astro:page-load', initLazyImages);
</script>
